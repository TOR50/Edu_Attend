name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: "3.11"

jobs:
  build-test-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libopenblas-dev \
            libjpeg-dev \
            pkg-config

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel pbr
          pip install -r requirements.txt bandit safety

      - name: Django checks
        env:
          DJANGO_SECRET_KEY: dummy-key
          DJANGO_DEBUG: "false"
        run: |
          python manage.py collectstatic --noinput
          python manage.py check --deploy

      - name: Run unit tests
        env:
          DJANGO_SECRET_KEY: dummy-key
          DJANGO_DEBUG: "false"
        run: |
          python manage.py test --noinput

      - name: Bandit static analysis
        continue-on-error: true
        run: bandit -r core config -ll

      - name: Safety dependency scan
        run: safety check --full-report --file requirements.txt

      - name: Prepare container image name
        id: prep-image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          echo "image=${IMAGE,,}" >> "$GITHUB_OUTPUT"

      - name: Build Docker image (no push on PR)
        run: docker build -t ${{ steps.prep-image.outputs.image }}:${{ github.sha }} .

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@0.17.0
        with:
          image-ref: ${{ steps.prep-image.outputs.image }}:${{ github.sha }}
          format: table
          ignore-unfixed: true
          vuln-type: 'os,library'

      - name: Log in to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Push image to GHCR
        if: github.event_name == 'push'
        run: |
          IMAGE=${{ steps.prep-image.outputs.image }}
          docker tag "$IMAGE:${{ github.sha }}" "$IMAGE:latest"
          docker push "$IMAGE:${{ github.sha }}"
          docker push "$IMAGE:latest"

      - name: Copy docker-compose stack
        if: github.event_name == 'push'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose.yml"
          target: "~/edu-attend"

      - name: Deploy to Ubuntu host
        if: github.event_name == 'push'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            DEPLOY_PATH="$HOME/edu-attend"
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
            if [ ! -f app.env ]; then
              echo 'app.env missing - create it before deploying' >&2
              exit 1
            fi
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
