# EduAttend - Ansible Configuration

This directory contains Ansible playbooks for automating deployment and configuration of the EduAttend application on Azure VM.

## ğŸ“‹ Prerequisites

1. **Ansible** - Configuration management tool
2. **SSH Access** - Private key for Azure VM (generated by Terraform)
3. **Python** - Python 3.x with pip
4. **Docker** - (Installed automatically by playbooks)

## ğŸš€ Quick Start

### Step 1: Install Ansible

**Windows (PowerShell):**
```powershell
# Install Python if not already installed
winget install Python.Python.3.11

# Install Ansible using pip
pip install ansible

# Verify installation
ansible --version
```

**Linux/MacOS:**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install ansible

# MacOS
brew install ansible
```

### Step 2: Set Environment Variables

Create a `.env` file or export variables:

```powershell
# Windows PowerShell
$env:GHCR_USERNAME = "TOR50"
$env:GHCR_TOKEN = "your_github_token"
$env:DATABASE_URL = "your_neon_postgres_url"
$env:CLOUDINARY_URL = "your_cloudinary_url"
$env:DJANGO_SECRET_KEY = "your_secret_key"
```

**Get GitHub Token:**
1. Go to: https://github.com/settings/tokens
2. Generate new token (classic)
3. Select scopes: `read:packages`, `write:packages`
4. Copy the token

### Step 3: Update Inventory with VM IP

After running `terraform apply`, update the inventory:

```powershell
# Get VM IP from Terraform
cd ../terraform
terraform output vm_public_ip

# Edit inventory file
cd ../ansible
# Replace REPLACE_WITH_VM_IP with actual IP in inventory/azure_hosts.yml
```

**Or use PowerShell:**
```powershell
$vmIp = (cd ../terraform; terraform output -raw vm_public_ip)
(Get-Content inventory/azure_hosts.yml) -replace 'REPLACE_WITH_VM_IP', $vmIp | Set-Content inventory/azure_hosts.yml
```

### Step 4: Test Connection

```powershell
# Test SSH connection
ansible all -m ping

# Expected output:
# eduattend-azure-vm | SUCCESS => {
#     "changed": false,
#     "ping": "pong"
# }
```

### Step 5: Run Playbooks

```powershell
# 1. Setup VM (install Docker, configure firewall)
ansible-playbook playbooks/01-setup-vm.yml

# 2. Deploy Application (pull container, run app)
ansible-playbook playbooks/02-deploy-app.yml

# 3. Install Nagios Monitoring
ansible-playbook playbooks/03-install-nagios.yml
```

**Run all at once:**
```powershell
ansible-playbook playbooks/01-setup-vm.yml playbooks/02-deploy-app.yml playbooks/03-install-nagios.yml
```

## ğŸ“‚ File Structure

```
ansible/
â”œâ”€â”€ ansible.cfg                 # Ansible configuration
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ azure_hosts.yml        # VM inventory (update IP here)
â”œâ”€â”€ playbooks/
â”‚   â”œâ”€â”€ 01-setup-vm.yml        # Initial VM setup
â”‚   â”œâ”€â”€ 02-deploy-app.yml      # Deploy Django app
â”‚   â””â”€â”€ 03-install-nagios.yml  # Setup monitoring
â””â”€â”€ README.md                   # This file
```

## ğŸ¯ Playbook Details

### 01-setup-vm.yml
**Purpose:** Initial VM configuration

**What it does:**
- Updates system packages
- Installs Docker and dependencies
- Configures UFW firewall (SSH, HTTP, Django, Nagios)
- Creates application directory
- Enables fail2ban for security

**Estimated time:** 3-5 minutes

### 02-deploy-app.yml
**Purpose:** Deploy EduAttend application

**What it does:**
- Logs into GitHub Container Registry
- Pulls latest Docker image
- Creates environment configuration
- Runs application container on port 8000
- Performs health checks

**Estimated time:** 2-3 minutes

### 03-install-nagios.yml
**Purpose:** Setup monitoring system

**What it does:**
- Installs Nagios Core 4.x
- Installs Nagios Plugins
- Configures Apache on port 8080
- Sets up monitoring for Render + Azure apps
- Creates admin user (nagiosadmin)

**Estimated time:** 10-15 minutes

## ğŸ”§ Configuration Options

Edit `inventory/azure_hosts.yml` to customize:

| Variable | Description | Default |
|----------|-------------|---------|
| `ansible_host` | VM IP address | From Terraform |
| `container_image` | Docker image to deploy | GHCR image |
| `django_allowed_hosts` | Allowed hosts for Django | VM IP |
| `nagios_admin_email` | Email for alerts | rauhan.official@gmail.com |
| `nagios_admin_password` | Nagios login password | nagiosadmin123 |

## ğŸ“Š Useful Commands

```powershell
# Check syntax
ansible-playbook playbooks/01-setup-vm.yml --syntax-check

# Dry run (check mode)
ansible-playbook playbooks/02-deploy-app.yml --check

# Run with verbose output
ansible-playbook playbooks/03-install-nagios.yml -v

# Run specific tasks with tags
ansible-playbook playbooks/01-setup-vm.yml --tags firewall

# List all tasks
ansible-playbook playbooks/01-setup-vm.yml --list-tasks

# Run ad-hoc commands
ansible all -m shell -a "docker ps"
ansible all -m shell -a "systemctl status nagios"
```

## ğŸ› Troubleshooting

### Issue: "Permission denied (publickey)"

**Solution:** Check SSH key path
```powershell
# Verify key exists
Test-Path "../.ssh/azure_vm_key"

# Check key permissions (should be 400/600)
icacls "../.ssh/azure_vm_key"
```

### Issue: "Failed to connect to host"

**Solution:** Verify VM is running and IP is correct
```powershell
# Check VM status
az vm show --resource-group eduattend-devops-rg --name eduattend-demo-vm --show-details

# Ping the VM
ping <VM_IP>

# Test SSH manually
ssh -i ../.ssh/azure_vm_key azureuser@<VM_IP>
```

### Issue: "Container pull failed"

**Solution:** Verify GHCR credentials
```powershell
# Test GHCR login locally
echo $env:GHCR_TOKEN | docker login ghcr.io -u $env:GHCR_USERNAME --password-stdin

# Verify image exists
docker pull ghcr.io/tor50/tor50-capstone_kc739_cse399:latest
```

### Issue: "Nagios installation timeout"

**Solution:** Increase timeout or run separately
```powershell
# Run with increased timeout
ansible-playbook playbooks/03-install-nagios.yml --timeout=300
```

## ğŸ”’ Security Best Practices

âœ… **Generated:**
- SSH key pair for secure access
- Firewall rules (UFW) restrict access
- Fail2ban protects against brute force

âš ï¸ **Change in Production:**
- `nagios_admin_password` in inventory
- `DJANGO_SECRET_KEY` environment variable
- Enable HTTPS with Let's Encrypt

## ğŸ“ Understanding Ansible

**Inventory:** Lists of servers to manage  
**Playbook:** YAML file with tasks  
**Module:** Reusable automation unit (apt, docker_container, etc.)  
**Handler:** Task triggered by events  
**Facts:** System information gathered automatically  

## ğŸ”„ Redeployment

**Update application:**
```powershell
# Pull latest code and redeploy
ansible-playbook playbooks/02-deploy-app.yml
```

**Restart services:**
```powershell
ansible all -m shell -a "docker restart eduattend-app" --become
ansible all -m shell -a "systemctl restart nagios" --become
```

## ğŸ“š Additional Resources

- [Ansible Documentation](https://docs.ansible.com/)
- [Docker Module](https://docs.ansible.com/ansible/latest/collections/community/docker/docker_container_module.html)
- [Nagios Documentation](https://www.nagios.org/documentation/)

## âœ… Verification Checklist

After running all playbooks:

- [ ] VM accessible via SSH
- [ ] Docker running: `docker ps`
- [ ] Application accessible: `http://<VM_IP>:8000`
- [ ] Nagios accessible: `http://<VM_IP>:8080/nagios`
- [ ] All Nagios services show GREEN
- [ ] Firewall configured: `sudo ufw status`

ğŸ‘‰ **Next:** Configure GitHub Actions CI/CD pipeline
