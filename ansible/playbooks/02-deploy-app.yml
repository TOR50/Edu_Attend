---
# Playbook 2: Deploy EduAttend Application (Simplified)
# Builds and runs the Django application in Docker

- name: Deploy EduAttend Application
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes
      register: docker_start
      until: docker_start is succeeded
      retries: 3
      delay: 5

    - name: Wait for Docker to be ready
      pause:
        seconds: 5

    - name: Stop and remove existing application container
      docker_container:
        name: eduattend-app
        state: absent
      register: container_removal
      ignore_errors: yes

    - name: Create environment variables file
      copy:
        dest: "{{ app_directory }}/app.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
        content: |
          DJANGO_SECRET_KEY={{ django_secret_key }}
          DJANGO_DEBUG={{ django_debug }}
          DJANGO_ALLOWED_HOSTS={{ django_allowed_hosts }}
          DATABASE_URL={{ database_url }}
          CLOUDINARY_URL={{ cloudinary_url }}
          DJANGO_CSRF_TRUSTED_ORIGINS=http://{{ ansible_host }},https://{{ ansible_host }}

    - name: Build Docker image from repository
      docker_image:
        name: eduattend-app
        tag: latest
        build:
          path: "{{ app_directory }}/repo"
          pull: no
        source: build
        force_source: yes
        state: present

    - name: Run application container
      docker_container:
        name: eduattend-app
        image: eduattend-app:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "8000:8000"
        env_file: "{{ app_directory }}/app.env"

    - name: Wait for application to start (port 8000)
      wait_for:
        port: 8000
        delay: 15
        timeout: 180

    - name: Check application health
      uri:
        url: "http://localhost:8000/"
        status_code: 200,302
        timeout: 30
      register: health_check
      retries: 3
      delay: 15
      until: health_check.status in [200, 302]

    - name: Display deployment success message
      debug:
        msg: |
          ‚úÖ Application Deployed Successfully!
          
          Access your application:
          üåê http://{{ ansible_host }}:8000
          
          Container Status:
          üì¶ Image: eduattend-app:latest (built locally)
          üîÑ Restart Policy: unless-stopped
          
          Next Steps:
          1. Access the application in your browser
          2. Login with your credentials
          3. Test face recognition features
          4. Proceed to Nagios monitoring setup
